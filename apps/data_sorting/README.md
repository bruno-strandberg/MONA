Data sorting
============
This directory has the code to sort the summary data from the Monte-Carlo chain (*ECAP PID*, see below) to an *analysis format* that is used by the software in `NMH/common_software`.

* *ECAP PID* is usually a flat `TTree` that contains all of the variables from reconstruction algorithms + the PID scores for all simulated Monte-Carlo events that pass the initial atmospheric-muon rejection cuts. More info (not always up-to-date) can be found at [https://wiki.km3net.de/index.php/ORCA_PID]. 

* *analysis format* is defined by the class `common_software/SummaryEvent.h/C`. More info is available in the master `NMH/README.md` file.

Prerequisities
==============
* The file `pid_result_XXX.root`, which refers to a PID summary file from ECAP. Such files can/could be found at `/sps/km3net/users/shallman/ORCA_PID_OUTPUT/04_18`, it is becoming a standard that these files are also available in iRODS. Typically, to know exactly which file to use, one must contact someone active in the ORCA working group.

* The configured and compiled library `NMH/common_software/`.

How to run
==========

This is a two-step process. First, the data from the PID summary file has to be converted to analysis format. This typically requires the creation of a new class to read the PID summary file (can be auto-generated by ROOT) and the creation of a new application that uses the reader and the `common_software/SummaryParser.h/C` class to map the data to *analysis format*. See section **Maintenance** below for instructions how to do so. Secondly, the data is to be split to several files by the application `RestoreParity` to match the file naming and numbering scheme used throughout the MC chain.

For example, this directory contains a reader class `PIDAlpha` and a corresponding application `PIDAlphaToSummary` to convert the file `/sps/km3net/users/shallman/ORCA_PID_OUTPUT/04_18/pid_result_shiftedVertexEventSelection.root` to *analysis format*. The applications can be run as follows:

1. Converters can be run as `./PIDAlphaToSummary -d ../../data/ -f ../../data/pid_result_XXX.root -t MY_TAG`, use `-h!` for more info. This creates the file `NMH/data/ORCA_MC_summary_MY_TAG.root`, which will contain all the same events as `NMH/data/pid_result_XXX.root`, but in the *analysis format*.
   
2. Run `RestoreParity -f ../../data/ORCA_MC_summary_MY_TAG.root -l 1+5 -u 3+100`, use `-h!` for more info. This will split the data up to several files in `NMH/data/mcsumary/MY_TAG/...` to match the file naming and numbering scheme used throughout the MC chain. This will take ~10 minutes. This step is required for the applications in `apps/effective_mass` to work (and some other applications) and allows for more flexibility in choosing how much MC data to use for various studies.

Maintenance
===========

Typically, the format of the PID output tree from ECAP is not fixed and changes with every update. If the format of the tree `pid_result_XXX.root` changes, the `PIDAlpha` class will no longer recongnize the `TTree` in the file. The application that uses the reader (`AlphaToSummary` in this case) will complain about missing/wrong branch names. Often, a new reader and an application need to be created to convert a new PID summary file to *analysis format*. This can be achieved with the helper script `createconverter.py` or manually, both options are described below.

Helper script
-------------
The python script `createconverter.py` can be used to create a `TTree` reader class and a skeleton application to convert the ECAP PID to *analysis format*. For example
```
./createconverter.py -s some_ecap_pid_file.root -n SomeReader -t PID
``` 
will create files `SomeReader.h/C` and `SomeReaderToSummary.C`. The user has to modify the latter to define exactly how to map variables from the input root file to output file in *analysis format*. Makefile modification is done automatically, so once the user has edited `SomeReaderToSummary.C`, she/he should type `make` and execute `./SomeReaderToSummary -h!` for running guidance.

Manual creation
----------------
Before the script `createconverter.py` was created, the following steps had to be done manually. Create a new reader by doing, e.g,

```
> root new_pid_file.root
> PID->MakeClass("PIDBeta")
```
Then, a new application `BetaToSummary` can be created that uses the class `PIDBeta` to convert the data to analysis format. Practically, this can be achieved easily and quickly by doing
```
cp AlphaToSummary.C BetaToSummary.C
```
and modifying the parts concerning the reader, data-mapping and documentation. Note that the new reader class source file `PIDBeta.C` needs to be added to the `COMMON` in the `Makefile`.

The `AlphaToSummary` application is a simple example how to map *ECAP PID* format to *analysis format*. If at some point *ECAP PID* takes a different form (currently I don't know what the ECAP deep learning PID will use), this application exemplifies how to map the data to *analysis format*.

The `RestoreParity` application operates on the *analysis format* and hence should work on the output of `Alpha(Beta...)ToSummary`, as long as the latter application has mapped the variables correctly.

